@model List<KoudakMalzeme.Shared.Entities.Malzeme>

@{
	ViewData["Title"] = "Malzeme Listesi";
}

<div class="container-fluid">
	<div class="row mb-4 align-items-center">
		<div class="col-md-6">
			<h2 class="text-success fw-bold"></i> Malzeme Listesi</h2>
		</div>
		<div class="col-md-6">
			<div class="d-flex gap-2">
				<select id="etiketFiltre" class="form-select border-secondary" style="max-width: 180px;">
					<option value="">Tüm Etiketler</option>
					@{

						var tumEtiketler = Model
						.Where(m => !string.IsNullOrEmpty(m.Etiketler))
						.SelectMany(m => m.Etiketler.Split(','))
						.Select(t => t.Trim())
						.Where(t => !string.IsNullOrEmpty(t))
						.Distinct()
						.OrderBy(t => t)
						.ToList();
					}
					@foreach (var etiket in tumEtiketler)
					{
						<option value="@etiket">@etiket</option>
					}
				</select>

				<div class="input-group">
					<span class="input-group-text bg-white border-end-0"><i
							class="fa-solid fa-search text-muted"></i></span>
					<input type="text" id="searchInput" class="form-control border-start-0"
						placeholder="Malzeme adı ile ara..." autocomplete="off">
				</div>
			</div>
		</div>
	</div>

	<div class="card shadow-sm border-0">
		<div class="card-body p-0">
			<div class="table-responsive">
				<table class="table table-hover align-middle mb-0" id="malzemeTable">
					<thead class="table-light">
						<tr>
							<th style="cursor: pointer; min-width: 250px;" onclick="sortTable(0)">
								Malzeme Adı <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
							<th style="cursor: pointer;" onclick="sortTable(1)">
								Açıklama <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
							<th style="cursor: pointer; width: 150px;" onclick="sortTable(2, true)">
								Stok <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
							<th style="cursor: pointer; width: 300px;" onclick="sortTable(3)">
								Emanet Alanlar <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var item in Model)
						{
							// --- EMANET HESAPLAMA MANTIĞI ---
							// 1. Kalan adedi 0'dan büyük olanlar (Hala emanette)
							// 2. Durumu 'TalepEdildi' OLMAYANLAR (Henüz teslim alınmamışsa listede görünmesin)
							var aktifEmanetler = item.EmanetGecmisi?
							.Where(d => d.KalanAdet > 0
							&& d.Emanet?.Uye != null
							&& d.Emanet.Durum != KoudakMalzeme.Shared.Enums.EmanetDurumu.TalepEdildi
							&& d.Emanet.Durum != KoudakMalzeme.Shared.Enums.EmanetDurumu.Reddedildi)
							.ToList() ?? new List<KoudakMalzeme.Shared.Entities.EmanetDetay>();

							// Kişi bazlı grupluyoruz
							var alanKisiler = aktifEmanetler
							.GroupBy(x => x.Emanet.Uye)
							.Select(g => new
							{
								AdSoyad = g.Key.Ad + " " + g.Key.Soyad,
								ToplamKalan = g.Sum(x => x.KalanAdet),
								Tarih = g.Max(x => x.Emanet.OlusturulmaTarihi)
							})
							.ToList();

							<tr data-tags="@item.Etiketler">
								<td>
									<div class="d-flex align-items-center">
										@if (!string.IsNullOrEmpty(item.GorselYolu))
										{
											<img src="@item.GorselYolu" alt="img" class="rounded-circle border me-3"
												style="width: 45px; height: 45px; object-fit: cover;"
												onerror="this.onerror=null;this.src='https://placehold.co/45x45?text=Img';" />
										}
										else
										{
											<div class="rounded-circle bg-light border d-flex align-items-center justify-content-center me-3"
												style="width: 45px; height: 45px;">
												<i class="fa-solid fa-cube text-secondary"></i>
											</div>
										}
										<span class="fw-bold text-dark">@item.Ad</span>
									</div>
								</td>

								<td class="text-muted small">
									@item.Aciklama
								</td>

								<td class="fw-bold text-center">
									@item.ToplamStok <span class="text-muted fw-normal">(@item.GuncelStok)</span>
								</td>

								<td class="text-center">
									<div data-value="@alanKisiler.Count">
										@if (alanKisiler.Any())
										{
											var gosterilecekIsimler = string.Join(", ", alanKisiler.Take(2).Select(x =>
											x.AdSoyad));
											var digerSayisi = alanKisiler.Count - 2;

											// Link rengi 'text-dark' yapılarak mavi olması engellendi
											<a href="#" class="text-decoration-none text-dark fw-bold" data-bs-toggle="modal"
												data-bs-target="#modal_@item.Id">
												@gosterilecekIsimler
												@if (digerSayisi > 0)
												{
													<span class="text-muted ms-1">(+@digerSayisi kişi)</span>
												}
											</a>
										}
										else
										{
											<span class="text-muted">-</span>
										}
									</div>
								</td>
							</tr>
						}
					</tbody>
				</table>
				@if (Model.Count == 0)
				{
					<div class="text-center py-5">
						<p class="text-muted">Listelenecek malzeme yok.</p>
					</div>
				}
			</div>
		</div>
	</div>
</div>

@foreach (var item in Model)
{
	// Modal içindeki veriler için de AYNI FİLTREYİ uyguluyoruz
	var aktifEmanetler = item.EmanetGecmisi?
	.Where(d => d.KalanAdet > 0
	&& d.Emanet?.Uye != null
	&& d.Emanet.Durum != KoudakMalzeme.Shared.Enums.EmanetDurumu.TalepEdildi
	&& d.Emanet.Durum != KoudakMalzeme.Shared.Enums.EmanetDurumu.Reddedildi)
	.ToList() ?? new List<KoudakMalzeme.Shared.Entities.EmanetDetay>();

	var alanKisiler = aktifEmanetler
	.GroupBy(x => x.Emanet.Uye)
	.Select(g => new
	{
		UyeBilgi = g.Key,
		ToplamKalan = g.Sum(x => x.KalanAdet),
		SonIslemTarihi = g.Max(x => x.Emanet.OlusturulmaTarihi)
	})
	.ToList();

	if (alanKisiler.Any())
	{
		<div class="modal fade" id="modal_@item.Id" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered modal-lg">
				<div class="modal-content">
					<div class="modal-header bg-light">
						<h5 class="modal-title text-success fw-bold">
							<i class="fa-solid fa-users-viewfinder me-2"></i> @item.Ad - Zimmet Listesi
						</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body p-0">
						<table class="table table-striped table-hover mb-0">
							<thead class="table-success">
								<tr>
									<th class="ps-4">Üye Bilgileri</th>
									<th>İletişim</th>
									<th class="text-center">Zimmet Adedi</th>
									<th class="text-end pe-4">Veriliş Tarihi</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var kisi in alanKisiler)
								{
									<tr>
										<td class="ps-4">
											<span class="fw-bold d-block">@kisi.UyeBilgi.Ad @kisi.UyeBilgi.Soyad</span>
											<span class="small text-muted">No: @kisi.UyeBilgi.OkulNo</span>
										</td>
										<td>
											<div class="d-flex flex-column small">
												<span><i class="fa-solid fa-phone text-success me-1"></i>
													@kisi.UyeBilgi.Telefon</span>
												<span class="text-muted"><i class="fa-solid fa-envelope me-1"></i>
													@kisi.UyeBilgi.Email</span>
											</div>
										</td>
										<td class="text-center align-middle">
											<span class="badge bg-danger rounded-pill px-3">@kisi.ToplamKalan</span>
										</td>
										<td class="text-end pe-4 align-middle text-muted">
											@kisi.SonIslemTarihi.ToString("dd.MM.yyyy HH:mm")
										</td>
									</tr>
								}
							</tbody>
						</table>
					</div>
					<div class="modal-footer bg-light">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
					</div>
				</div>
			</div>
		</div>
	}
}

@section Scripts {
	<script>
		$(document).ready(function () {
			$("#searchInput, #etiketFiltre").on("keyup change", function () {
				filtrele();
			});
		});

		function filtrele() {
			var aramaMetni = $("#searchInput").val().toLowerCase();
			var secilenEtiket = $("#etiketFiltre").val().toLowerCase();

			$("#malzemeTable tbody tr").filter(function () {
				var isim = $(this).find("td:eq(0)").text().toLowerCase();
				var isimUyuyor = isim.indexOf(aramaMetni) > -1;

				var etiketler = $(this).attr("data-tags") ? $(this).attr("data-tags").toLowerCase() : "";
				var etiketUyuyor = secilenEtiket === "" || etiketler.indexOf(secilenEtiket) > -1;

				$(this).toggle(isimUyuyor && etiketUyuyor);
			});
		}

		function sortTable(n, isNumber = false) {
			var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
			table = document.getElementById("malzemeTable");
			switching = true;
			dir = "asc";

			while (switching) {
				switching = false;
				rows = table.rows;
				for (i = 1; i < (rows.length - 1); i++) {
					shouldSwitch = false;
					x = rows[i].getElementsByTagName("TD")[n];
					y = rows[i + 1].getElementsByTagName("TD")[n];

					var xVal = x.querySelector('[data-value]') ? x.querySelector('[data-value]').getAttribute('data-value') : x.innerText.trim().toLowerCase();
					var yVal = y.querySelector('[data-value]') ? y.querySelector('[data-value]').getAttribute('data-value') : y.innerText.trim().toLowerCase();

					if (isNumber) {
						var xNum = parseInt(xVal.split(' ')[0]) || 0;
						var yNum = parseInt(yVal.split(' ')[0]) || 0;
						if (dir == "asc") { if (xNum > yNum) { shouldSwitch = true; break; } }
						else { if (xNum < yNum) { shouldSwitch = true; break; } }
					} else {
						if (dir == "asc") { if (xVal > yVal) { shouldSwitch = true; break; } }
						else { if (xVal < yVal) { shouldSwitch = true; break; } }
					}
				}
				if (shouldSwitch) {
					rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
					switching = true;
					switchcount++;
				} else {
					if (switchcount == 0 && dir == "asc") {
						dir = "desc";
						switching = true;
					}
				}
			}
		}
	</script>
}