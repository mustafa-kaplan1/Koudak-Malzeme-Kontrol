@model List<KoudakMalzeme.Shared.Entities.Malzeme>

@{
	ViewData["Title"] = "Malzeme Listesi";
}

<div class="container-fluid">
	<div class="row mb-4 align-items-center">
		<div class="col-md-6">
			<h2 class="text-success fw-bold"><i class="fa-solid fa-boxes-stacked"></i> Malzeme Listesi</h2>
		</div>
		<div class="col-md-6">
			<div class="input-group">
				<span class="input-group-text bg-white border-end-0"><i
						class="fa-solid fa-search text-muted"></i></span>
				<input type="text" id="searchInput" class="form-control border-start-0"
					placeholder="Malzeme adı ile ara..." autocomplete="off">
			</div>
		</div>
	</div>

	<div class="card shadow-sm border-0">
		<div class="card-body p-0">
			<div class="table-responsive">
				<table class="table table-hover align-middle mb-0" id="malzemeTable">
					<thead class="table-light">
						<tr>
							<th style="cursor: pointer; min-width: 250px;" onclick="sortTable(0)">
								Malzeme Adı <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
							<th style="cursor: pointer;" onclick="sortTable(1)">
								Açıklama <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
							<th style="cursor: pointer; width: 150px;" onclick="sortTable(2, true)">
								Stok <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
							<th style="cursor: pointer; width: 300px;" onclick="sortTable(3)">
								Emanet Alanlar <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var item in Model)
						{
							// --- EMANET HESAPLAMA MANTIĞI ---
							// Sadece elinde malzeme kalan (iade edilmemiş) kayıtları alıyoruz.
							var aktifEmanetler = item.EmanetGecmisi?
							.Where(d => d.KalanAdet > 0 && d.Emanet?.Uye != null)
							.ToList() ?? new List<KoudakMalzeme.Shared.Entities.EmanetDetay>();

							// Kişi bazlı grupluyoruz (Bir kişi aynı malzemeden farklı zamanlarda 2 kere almış olabilir)
							var alanKisiler = aktifEmanetler
							.GroupBy(x => x.Emanet.Uye)
							.Select(g => new
							{
								AdSoyad = g.Key.Ad + " " + g.Key.Soyad,
								ToplamKalan = g.Sum(x => x.KalanAdet), // O kişide toplam kaç tane var
								Tarih = g.Max(x => x.Emanet.OlusturulmaTarihi) // En son ne zaman almış
							})
							.ToList();

							<tr>
								<td>
									<div class="d-flex align-items-center">
										@if (!string.IsNullOrEmpty(item.GorselYolu))
										{
											<img src="@item.GorselYolu" alt="img" class="rounded-circle border me-3"
												style="width: 45px; height: 45px; object-fit: cover;"
												onerror="this.onerror=null;this.src='https://placehold.co/45x45?text=Img';" />
										}
										else
										{
											<div class="rounded-circle bg-light border d-flex align-items-center justify-content-center me-3"
												style="width: 45px; height: 45px;">
												<i class="fa-solid fa-cube text-secondary"></i>
											</div>
										}
										<span class="fw-bold text-dark">@item.Ad</span>
									</div>
								</td>

								<td class="text-muted small">
									@item.Aciklama
								</td>

								<td class="fw-bold text-center">
									@item.ToplamStok <span class="text-muted fw-normal">(@item.GuncelStok)</span>
								</td>

								<td class="text-center">
									<div data-value="@alanKisiler.Count">
										@if (alanKisiler.Any())
										{
											// İlk 2 ismi virgülle ayırarak göster
											var gosterilecekIsimler = string.Join(", ", alanKisiler.Take(2).Select(x =>
											x.AdSoyad));
											var digerSayisi = alanKisiler.Count - 2;

											<a href="#" class="text-decoration-none text-primary fw-bold" data-bs-toggle="modal"
												data-bs-target="#modal_@item.Id">
												@gosterilecekIsimler
												@if (digerSayisi > 0)
												{
													<span class="text-muted ms-1">(+@digerSayisi kişi)</span>
												}
											</a>

											<div class="modal fade" id="modal_@item.Id" tabindex="-1" aria-hidden="true">
												<div class="modal-dialog modal-dialog-centered">
													<div class="modal-content">
														<div class="modal-header bg-light">
															<h5 class="modal-title text-success fw-bold">
																@item.Ad - Emanet Listesi
															</h5>
															<button type="button" class="btn-close" data-bs-dismiss="modal"
																aria-label="Close"></button>
														</div>
														<div class="modal-body p-0">
															<table class="table table-striped mb-0">
																<thead>
																	<tr>
																		<th>Üye Adı</th>
																		<th class="text-center">Adet</th>
																		<th class="text-end">Tarih</th>
																	</tr>
																</thead>
																<tbody>
																	@foreach (var kisi in alanKisiler)
																	{
																		<tr>
																			<td class="text-start ps-3">@kisi.AdSoyad</td>
																			<td class="text-center fw-bold">@kisi.ToplamKalan</td>
																			<td class="text-end pe-3 small text-muted">
																				@kisi.Tarih.ToShortDateString()
																			</td>
																		</tr>
																	}
																</tbody>
															</table>
														</div>
														<div class="modal-footer">
															<button type="button" class="btn btn-secondary btn-sm"
																data-bs-dismiss="modal">Kapat</button>
														</div>
													</div>
												</div>
											</div>
										}
										else
										{
											<span class="text-muted">-</span>
										}
									</div>
								</td>
							</tr>
						}
					</tbody>
				</table>

				@if (Model.Count == 0)
				{
					<div class="text-center py-5">
						<p class="text-muted">Listelenecek malzeme yok.</p>
					</div>
				}
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		// --- ANLIK ARAMA ---
		$(document).ready(function () {
			$("#searchInput").on("keyup", function () {
				var value = $(this).val().toLowerCase();
				$("#malzemeTable tbody tr").filter(function () {
					var text = $(this).find("td:eq(0)").text().toLowerCase();
					$(this).toggle(text.indexOf(value) > -1)
				});
			});
		});

		// --- SIRALAMA FONKSİYONU ---
		function sortTable(n, isNumber = false) {
			var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
			table = document.getElementById("malzemeTable");
			switching = true;
			dir = "asc";

			while (switching) {
				switching = false;
				rows = table.rows;
				for (i = 1; i < (rows.length - 1); i++) {
					shouldSwitch = false;
					x = rows[i].getElementsByTagName("TD")[n];
					y = rows[i + 1].getElementsByTagName("TD")[n];

					var xVal = x.querySelector('[data-value]') ? x.querySelector('[data-value]').getAttribute('data-value') : x.innerText.trim().toLowerCase();
					var yVal = y.querySelector('[data-value]') ? y.querySelector('[data-value]').getAttribute('data-value') : y.innerText.trim().toLowerCase();

					if (isNumber) {
						var xNum = parseInt(xVal.split(' ')[0]) || 0;
						var yNum = parseInt(yVal.split(' ')[0]) || 0;

						if (dir == "asc") { if (xNum > yNum) { shouldSwitch = true; break; } }
						else { if (xNum < yNum) { shouldSwitch = true; break; } }
					} else {
						if (dir == "asc") { if (xVal > yVal) { shouldSwitch = true; break; } }
						else { if (xVal < yVal) { shouldSwitch = true; break; } }
					}
				}

				if (shouldSwitch) {
					rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
					switching = true;
					switchcount++;
				} else {
					if (switchcount == 0 && dir == "asc") {
						dir = "desc";
						switching = true;
					}
				}
			}
		}
	</script>
}