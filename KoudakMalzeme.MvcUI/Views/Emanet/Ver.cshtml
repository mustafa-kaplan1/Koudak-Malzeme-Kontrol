@model KoudakMalzeme.MvcUI.Models.EmanetVerViewModel
@{
	ViewData["Title"] = "Emanet Ver";
}

<div class="row">
	<div class="col-md-5">
		<div class="card shadow border-0">
			<div class="card-header bg-success text-white">
				<h5 class="mb-0"><i class="fa-solid fa-cart-plus"></i> İşlem Başlat</h5>
			</div>
			<div class="card-body">
				<div class="mb-3">
					<label class="form-label fw-bold">Üye Okul No</label>
					<div class="input-group">
						<input type="text" id="uyeOkulNo" class="form-control" placeholder="Örn: 190..." />
						<button class="btn btn-outline-secondary" type="button" id="btnUyeBul">Bul</button>
					</div>
					<div id="uyeBilgiAlani" class="mt-2 text-primary small fw-bold"></div>
					<input type="hidden" id="secilenUyeId" />
				</div>

				<hr />

				<div class="mb-3">
					<label class="form-label fw-bold">Malzeme Seç</label>
					<select id="malzemeSelect" class="form-select">
						<option value="">-- Seçiniz --</option>
						@foreach (var m in Model.Malzemeler)
						{
							<option value="@m.Id" data-stok="@m.GuncelStok" data-ad="@m.Ad">@m.Ad (Stok: @m.GuncelStok)
							</option>
						}
					</select>
				</div>

				<div class="mb-3">
					<label class="form-label fw-bold">Adet</label>
					<input type="number" id="adetInput" class="form-control" value="1" min="1" />
				</div>

				<button class="btn btn-warning w-100" id="btnListeyeEkle">
					<i class="fa-solid fa-plus"></i> Listeye Ekle
				</button>
			</div>
		</div>
	</div>

	<div class="col-md-7">
		<div class="card shadow border-0 h-100">
			<div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
				<h5 class="mb-0">Verilecek Malzemeler</h5>
				<span class="badge bg-danger" id="toplamKalem">0 Kalem</span>
			</div>
			<div class="card-body p-0">
				<table class="table table-striped table-hover mb-0">
					<thead class="table-light">
						<tr>
							<th>Malzeme</th>
							<th style="width: 100px;">Adet</th>
							<th style="width: 50px;"></th>
						</tr>
					</thead>
					<tbody id="sepetBody">
					</tbody>
				</table>

				<div id="bosSepetMesaji" class="text-center py-5 text-muted">
					<i class="fa-solid fa-basket-shopping fa-3x mb-3"></i>
					<p>Liste boş.</p>
				</div>
			</div>
			<div class="card-footer bg-white p-3">
				<div class="mb-3">
					<label class="form-label text-muted small">Not (Opsiyonel)</label>
					<input type="text" id="islemNotu" class="form-control form-control-sm"
						placeholder="Örn: Kamp faaliyeti için..." />
				</div>
				<button class="btn btn-success btn-lg w-100" id="btnOnayla">
					<i class="fa-solid fa-check"></i> Emaneti Onayla ve Bitir
				</button>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		// --- Sepet Mantığı ---
		let sepet = [];

		// 1. Üye Bulma (Şimdilik Dummy - Gerçeğinde API'ye sorulmalı)
		// Burada basitlik olsun diye inputa girilen değeri direkt kabul ediyoruz.
		// Gerçekte: $.get('/api/kullanici/bul?no=' + no)...
		$('#btnUyeBul').click(function () {
			var no = $('#uyeOkulNo').val();
			if (no) {
				// Şimdilik API entegrasyonu yoksa (kullanıcı listesi elimizde değilse)
				// ID'yi manuel girmek zorunda kalmamak için "AdminUyeEkle" metoduna bakmak lazım.
				// Basitlik adına: Kullanıcı ID'sini şimdilik "1" varsayacağız (Test İçin).
				// İLERİDE BURAYA API ÇAĞRISI EKLENECEK.

				$('#secilenUyeId').val(1); // Test kullanıcısı ID'si
				$('#uyeBilgiAlani').html('<i class="fa-solid fa-user-check"></i> Öğrenci Bulundu (Demo Modu)');
			} else {
				alert('Lütfen numara girin');
			}
		});

		// 2. Listeye Ekleme
		$('#btnListeyeEkle').click(function () {
			var mSelect = $('#malzemeSelect option:selected');
			var mId = mSelect.val();
			var mAd = mSelect.data('ad');
			var mStok = parseInt(mSelect.data('stok'));
			var adet = parseInt($('#adetInput').val());

			if (!mId) { alert('Malzeme seçiniz'); return; }
			if (adet <= 0) { alert('Geçersiz adet'); return; }
			if (adet > mStok) { alert('Yetersiz stok! Mevcut: ' + mStok); return; }

			// Sepette var mı kontrol et
			var mevcut = sepet.find(x => x.malzemeId == mId);
			if (mevcut) {
				if (mevcut.adet + adet > mStok) { alert('Toplam miktar stoğu aşıyor!'); return; }
				mevcut.adet += adet;
			} else {
				sepet.push({ malzemeId: mId, ad: mAd, adet: adet });
			}

			TabloyuGuncelle();
		});

		// 3. Tabloyu Çiz
		function TabloyuGuncelle() {
			var html = '';
			sepet.forEach((item, index) => {
				html += `<tr>
	                            <td>${item.ad}</td>
	                            <td>${item.adet}</td>
	                            <td><button class="btn btn-sm btn-outline-danger" onclick="Sil(${index})"><i class="fa-solid fa-times"></i></button></td>
	                         </tr>`;
			});

			$('#sepetBody').html(html);
			$('#toplamKalem').text(sepet.length + ' Kalem');

			if (sepet.length > 0) $('#bosSepetMesaji').hide();
			else $('#bosSepetMesaji').show();
		}

		// 4. Silme Fonksiyonu
		window.Sil = function (index) {
			sepet.splice(index, 1);
			TabloyuGuncelle();
		}

		// 5. Kaydetme (API'ye Gönder)
		$('#btnOnayla').click(function () {
			var uyeId = $('#secilenUyeId').val();
			if (!uyeId) { alert('Lütfen önce üyeyi seçin.'); return; }
			if (sepet.length === 0) { alert('Sepet boş.'); return; }

			var data = {
				UyeId: parseInt(uyeId),
				VerenPersonelId: 0, // Backend token'dan alacak
				Not: $('#islemNotu').val(),
				Kalemler: sepet.map(x => ({ MalzemeId: parseInt(x.malzemeId), Adet: x.adet }))
			};

			// AJAX Post
			$.ajax({
				url: '/Emanet/Ver',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(data),
				success: function (res) {
					if (res.basarili) {
						alert('Emanet işlemi başarıyla kaydedildi!');
						window.location.href = '/Emanet/Ver'; // Sayfayı yenile
					} else {
						alert('Hata: ' + res.mesaj);
					}
				},
				error: function () {
					alert('Sunucu hatası oluştu.');
				}
			});
		});
	</script>
}