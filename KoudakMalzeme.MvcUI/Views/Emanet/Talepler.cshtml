@using KoudakMalzeme.Shared.Enums
@model List<KoudakMalzeme.Shared.Entities.Emanet>

@{
	ViewData["Title"] = "Talep Yönetimi";
}

<h2 class="mb-4 fw-bold text-secondary">
	Talep Yönetimi
</h2>

@if (Model.Count == 0)
{
	<div class="alert alert-success shadow-sm">
		<i class="fa-solid fa-check-circle me-2"></i> Bekleyen talep bulunmamaktadır.
	</div>
}
else
{
	<div class="row">
		@foreach (var talep in Model)
		{
			// Talep Tipini Belirle
			bool iadeMi = talep.Durum == EmanetDurumu.IadeTalepEdildi;
			string kartRengi = iadeMi ? "border-danger" : "border-success";
			string baslikRengi = iadeMi ? "text-danger" : "text-success";
			string tipMetni = iadeMi ? "İADE TALEBİ" : "MALZEME TALEBİ";

			<div class="col-md-6 col-xl-4 mb-4">
				<div class="card h-100 border-0 shadow-sm border-top border-4 @kartRengi">
					<div class="card-body">
						<div class="d-flex justify-content-between mb-2">
							<div>
								<h6 class="fw-bold mb-0 @baslikRengi">
									@tipMetni
								</h6>
								<small class="text-muted">@talep.TeslimAlmaTarihi.ToString("dd.MM.yyyy HH:mm")</small>
							</div>
							<span class="badge bg-warning text-dark align-self-start">Bekliyor</span>
						</div>

						<div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
							<div class="avatar me-2 bg-white rounded-circle d-flex align-items-center justify-content-center"
								style="width:40px; height:40px; border:1px solid #ddd;">
								<i class="fa-solid fa-user text-muted"></i>
							</div>
							<div>
								<div class="fw-bold">@talep.Uye?.Ad @talep.Uye?.Soyad</div>
								<div class="small text-muted">@talep.Uye?.OkulNo</div>
							</div>
						</div>

						<h6 class="small text-uppercase fw-bold text-muted mb-2">İşlem Kalemleri</h6>
						<ul class="list-group list-group-flush mb-3 border rounded-1">
							@{
								// Eğer İade Talebiyse: Sadece 'IadeTalepEdilenAdet > 0' olanları göster ve o adedi yaz.
								// Eğer Alma Talebiyse: Hepsini göster ve 'AlinanAdet'i yaz.
								var gosterilecekDetaylar = iadeMi
								? talep.EmanetDetaylari.Where(d => d.IadeTalepEdilenAdet > 0).ToList()
								: talep.EmanetDetaylari;
							}

							@foreach (var detay in gosterilecekDetaylar)
							{
								var adetBilgisi = iadeMi ? detay.IadeTalepEdilenAdet : detay.AlinanAdet;

								<li class="list-group-item d-flex justify-content-between align-items-center py-2">
									<span>@detay.Malzeme?.Ad</span>
									<span class="badge bg-secondary rounded-pill">x @adetBilgisi</span>
								</li>
							}
						</ul>

						<div class="d-grid gap-2">
							@if (iadeMi)
							{
								// İADE ONAY BUTONU
								<button class="btn btn-outline-danger"
									onclick="iadeOnayModalAc(@talep.Id, '@talep.Uye.Ad @talep.Uye.Soyad')">
									<i class="fa-solid fa-check"></i> İadeyi Teslim Al
								</button>
							}
							else
							{
								// VERME ONAY BUTONU
								<button class="btn btn-success"
									onclick="vermeOnayModalAc(@talep.Id, '@talep.Uye.Ad @talep.Uye.Soyad')">
									<i class="fa-solid fa-check"></i> Malzemeleri Teslim Et
								</button>
							}

							<button class="btn btn-link text-muted text-decoration-none btn-sm" onclick="redModalAc(@talep.Id)">
								<i class="fa-solid fa-xmark"></i> Reddet / İptal
							</button>
						</div>
					</div>
				</div>
			</div>
		}
	</div>
}

<div class="modal fade" id="modalIslem" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="modalBaslik">İşlem Onayı</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<input type="hidden" id="onayEmanetId" />
				<p id="modalMesaj"></p>

				<div class="mb-3" id="divPlanlananTarih">
					<label class="form-label">Geri Getirme Tarihi (Planlanan)</label>
					<input type="date" id="onayTarih" class="form-control" />
				</div>

				<div class="mb-3">
					<label class="form-label">Personel Notu</label>
					<textarea id="onayNotu" class="form-control" rows="2"></textarea>
				</div>
			</div>
			<div class="modal-footer">
				<button class="btn btn-primary" onclick="talebiOnaylaAPI()">Onayla</button>
			</div>
		</div>
	</div>
</div>

<script>
	// MALZEME VERME SENARYOSU
	function vermeOnayModalAc(id, ad) {
		$('#onayEmanetId').val(id);
		$('#modalBaslik').text("Malzeme Teslim Et");
		$('#modalMesaj').html("<b>" + ad + "</b> isimli üyeye malzemeleri teslim etmek ve stoktan düşmek üzeresiniz.");

		// Tarih alanını göster
		$('#divPlanlananTarih').show();
		var date = new Date();
		date.setDate(date.getDate() + 14); // Varsayılan 2 hafta
		$('#onayTarih').val(date.toISOString().split('T')[0]);

		$('#modalIslem').modal('show');
	}

	// İADE ALMA SENARYOSU
	function iadeOnayModalAc(id, ad) {
		$('#onayEmanetId').val(id);
		$('#modalBaslik').text("İade Teslim Al");
		$('#modalMesaj').html("<b>" + ad + "</b> isimli üyenin getirdiği malzemeleri teslim alıp stoğa geri eklemek üzeresiniz.");

		// İadede planlanan tarih olmaz, gizle
		$('#divPlanlananTarih').hide();
		$('#onayNotu').val("Eksiksiz teslim alındı.");

		$('#modalIslem').modal('show');
	}

	function talebiOnaylaAPI() {
		var data = {
			EmanetId: $('#onayEmanetId').val(),
			MalzemeciNotu: $('#onayNotu').val(),
			// Tarih gizliyse null gönderelim
			PlanlananIadeTarihi: $('#divPlanlananTarih').is(':visible') ? $('#onayTarih').val() : null
		};

		$.ajax({
			url: '/Emanet/Onayla',
			type: 'POST',
			contentType: 'application/json',
			data: JSON.stringify(data),
			success: function (res) {
				if (res.success) location.reload();
				else alert("Hata: " + res.message);
			}
		});
	}
</script>