@model KoudakMalzeme.MvcUI.Models.KullaniciProfilViewModel
@{
	ViewData["Title"] = "Kullanıcı Profili";
}

<div class="row">
	<div class="col-md-4 mb-4">
		<div class="card shadow border-0 text-center h-100">
			<div class="card-body">
				<div class="bg-success text-white rounded-circle mx-auto d-flex justify-content-center align-items-center mb-3 display-4 shadow"
					style="width: 100px; height: 100px;">
					@(Model.Kullanici.Ad.Length > 0 ? Model.Kullanici.Ad[0] : '?')
				</div>
				<h3 class="fw-bold">@Model.Kullanici.Ad @Model.Kullanici.Soyad</h3>
				<p class="text-muted mb-1">@Model.Kullanici.OkulNo</p>
				<p class="badge bg-dark mb-4">@Model.Kullanici.Rol</p>
				@if (Model.KendiProfiliMi)
				{
					<div class="mt-4 d-grid gap-2">
						<a asp-controller="Emanet" asp-action="Al" class="btn btn-success">
							<i class="fa-solid fa-plus"></i> Malzeme Al
						</a>
						<a asp-controller="Account" asp-action="Logout" class="btn btn-danger">
							<i class="fa-solid fa-right-from-bracket"></i> Çıkış Yap
						</a>
					</div>
				}
			</div>
		</div>
	</div>

	@* Sağ Taraf *@
	<div class="col-md-8">
		<div class="card shadow border-0 mb-4">
			<div class="card-header bg-warning text-dark border-bottom-0 pt-3 pb-2">
				<h5 class="fw-bold mb-0">
					<i class="fa-solid fa-hand-holding-box me-2"></i> Zimmetindeki Malzemeler
				</h5>
			</div>
			<div class="card-body p-0">
				@if (Model.AktifZimmetListesi.Count > 0)
				{
					<table class="table table-striped mb-0">
						<thead class="table-light">
							<tr>
								<th>Malzeme</th>
								<th class="text-center">Adet</th>
								<th>Veriliş Tarihi</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var item in Model.AktifZimmetListesi)
							{
								<tr>
									<td class="fw-bold">@item.MalzemeAdi</td>
									<td class="text-center"><span class="badge bg-danger">@item.Adet</span></td>
									<td>@item.VerilisTarihi.ToString("dd.MM.yyyy")</td>
								</tr>
							}
						</tbody>
					</table>
				}
				else
				{
					<div class="p-4 text-center text-muted">
						<i class="fa-solid fa-check-circle fa-2x text-success mb-2"></i>
						<p class="mb-0">Şu an üzerinde zimmetli malzeme bulunmamaktadır.</p>
					</div>
				}
			</div>
		</div>

		<div class="card shadow border-0">
			<div class="card-header bg-white border-bottom-0 pt-4 pb-0">
				<h5 class="fw-bold text-secondary"> Emanet İşlem Geçmişi</h5>
			</div>
			<div class="card-body">
				@if (Model.Emanetler.Count == 0)
				{
					<div class="text-center py-5 text-muted">
						<p>Henüz kayıtlı bir emanet işlemi yok.</p>
					</div>
				}
				else
				{
					<div class="table-responsive">
						<table class="table table-hover align-middle">
							<thead class="table-light">
								<tr>
									<th>Emanet No</th>
									<th>Alış Tarihi</th>
									<th>İade Tarihi</th>
									<th>Durum</th>
									<th style="min-width: 160px;">İşlemler</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var emanet in Model.Emanetler.OrderByDescending(x => x.TeslimAlmaTarihi))
								{
									<tr>
										<td><small class="text-muted">#@emanet.Id</small></td>
										<td>@emanet.TeslimAlmaTarihi.ToString("dd.MM.yyyy")</td>
										<td>
											@(emanet.IadeTarihi.HasValue? emanet.IadeTarihi.Value.ToString("dd.MM.yyyy") : "-")
										</td>
										<td>
											@if (emanet.Durum == KoudakMalzeme.Shared.Enums.EmanetDurumu.TeslimEdildi)
											{
												<span class="badge bg-warning text-dark">Aktif</span>
											}
											else if (emanet.Durum == KoudakMalzeme.Shared.Enums.EmanetDurumu.KismenIadeEdildi)
											{
												<span class="badge bg-info">Kısmen İade</span>
											}
											else if (emanet.Durum == KoudakMalzeme.Shared.Enums.EmanetDurumu.Tamamlandi)
											{

												<span class="badge bg-success">Tamamlandı</span>
											}
											else
											{

												<span class="badge bg-danger">@emanet.Durum</span>
											}
										</td>
										<td>
											<button class="btn btn-sm btn-outline-info me-1" data-bs-toggle="modal"
												data-bs-target="#detayModal-@emanet.Id">
												<i class="fa-solid fa-eye"></i> Detay
											</button>

											@if (emanet.Durum == KoudakMalzeme.Shared.Enums.EmanetDurumu.TeslimEdildi ||
																				emanet.Durum == KoudakMalzeme.Shared.Enums.EmanetDurumu.KismenIadeEdildi)
											{
												if (Model.KendiProfiliMi || User.IsInRole("Admin") || User.IsInRole("Malzemeci"))
												{
													<a asp-controller="Emanet" asp-action="IadeEt" asp-route-id="@emanet.Id"
														class="btn btn-sm btn-outline-success">
														<i class="fa-solid fa-rotate-left"></i> İade Et
													</a>
												}
											}
										</td>
									</tr>
								}
							</tbody>
						</table>
					</div>
				}
			</div>
		</div>
	</div>
</div>

@foreach (var emanet in Model.Emanetler)
{
	<div class="modal fade" id="detayModal-@emanet.Id" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header bg-light">
					<h5 class="modal-title text-primary fw-bold">Emanet Detayı (#@emanet.Id)</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<h6 class="text-muted small text-uppercase fw-bold mb-3">Malzemeler</h6>
					<ul class="list-group list-group-flush border rounded mb-3">
						@foreach (var d in emanet.EmanetDetaylari)
						{
							<li class="list-group-item d-flex justify-content-between align-items-center">
								<span>@d.Malzeme?.Ad</span>
								<div>
									<span class="badge bg-primary rounded-pill me-1">Alınan: @d.AlinanAdet</span>
									<span class="badge bg-secondary rounded-pill">İade: @d.IadeEdilenAdet</span>
								</div>
							</li>
						}
					</ul>
					<div class="alert alert-light border">
						<div class="fw-bold mb-1">
							<i class="fa-solid fa-circle-info me-2"></i>Malzemeci Notu:
						</div>
						<div style="white-space: pre-wrap;">@(string.IsNullOrEmpty(emanet.MalzemeciNotu) ? "-" :
													emanet.MalzemeciNotu)</div>
					</div>
				</div>
			</div>
		</div>
	</div>
}