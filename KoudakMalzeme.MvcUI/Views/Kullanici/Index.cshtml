@model List<KoudakMalzeme.Shared.Entities.Kullanici>
@{
	ViewData["Title"] = "Üye Listesi";
}

<div class="container-fluid">
	<div class="row mb-4 align-items-center">
		<div class="col-md-6">
			<h2 class="text-success fw-bold"><i class="fa-solid fa-users"></i> Kulüp Üyeleri</h2>
		</div>
		<div class="col-md-6">
			<div class="input-group">
				<span class="input-group-text bg-white border-end-0"><i
						class="fa-solid fa-search text-muted"></i></span>
				<input type="text" id="searchInput" class="form-control border-start-0"
					placeholder="İsim veya Okul No ile ara..." autocomplete="off">
			</div>
		</div>
	</div>

	<div class="card shadow-sm border-0">
		<div class="card-body p-0">
			<div class="table-responsive">
				<table class="table table-hover align-middle mb-0" id="kullaniciTable">
					<thead class="table-light">
						<tr>
							<th style="cursor: pointer; min-width: 200px;" onclick="sortTable(0)">
								Ad Soyad <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
							<th style="cursor: pointer;" onclick="sortTable(1)">
								Okul No <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
							<th style="cursor: pointer;" onclick="sortTable(2)">
								Rol <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
							<th style="cursor: pointer; min-width: 250px;" onclick="sortTable(3, true)"> Sahip Olduğu
								Malzemeler <i class="fa-solid fa-sort text-muted small ms-1"></i>
							</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var user in Model)
						{
							// Aktif zimmetleri hesapla (Tamamlandı ve İptal Edildi haricindekiler)
							var aktifEmanetler = user.AldigiEmanetler?
							.Where(e => e.Durum != KoudakMalzeme.Shared.Enums.EmanetDurumu.Tamamlandi &&
							e.Durum != KoudakMalzeme.Shared.Enums.EmanetDurumu.IptalEdildi)
							.SelectMany(e => e.EmanetDetaylari)
							.ToList();

							int parcaSayisi = aktifEmanetler?.Sum(d => d.KalanAdet) ?? 0;

							// Malzeme isimlerini al (Tekrar edenleri grupla veya direkt listele)
							var malzemeIsimleri = aktifEmanetler?
							.Select(d => d.Malzeme?.Ad)
							.Where(ad => !string.IsNullOrEmpty(ad))
							.Distinct()
							.ToList();

							string malzemeOzet = malzemeIsimleri != null && malzemeIsimleri.Any()
							? string.Join(", ", malzemeIsimleri.Take(3)) + (malzemeIsimleri.Count > 3 ? "..." : "")
							: "";

							<tr>
								<td>
									<a asp-action="Profil" asp-route-id="@user.Id" class="text-decoration-none text-dark">
										<div class="d-flex align-items-center">
											<div class="bg-success text-white rounded-circle d-flex justify-content-center align-items-center me-3"
												style="width: 40px; height: 40px; font-weight: bold;">
												@(user.Ad.Length > 0 ? user.Ad[0] : '?')
											</div>
											<div class="d-flex flex-column">
												<span class="fw-bold">@user.Ad @user.Soyad</span>
												<small class="text-muted d-none d-md-block">@user.Email</small>
											</div>
										</div>
									</a>
								</td>

								<td class="fw-bold text-secondary">
									@user.OkulNo
								</td>

								<td>
									@if (user.Rol == KoudakMalzeme.Shared.Enums.KullaniciRolu.Admin)
									{
										<span class="badge bg-danger">Yönetici</span>
									}
									else if (user.Rol == KoudakMalzeme.Shared.Enums.KullaniciRolu.Malzemeci)
									{
										<span class="badge bg-warning text-dark">Malzemeci</span>
									}
									else
									{
										<span class="badge bg-secondary">Üye</span>
									}
								</td>

								<td>
									<a asp-action="Profil" asp-route-id="@user.Id" class="text-decoration-none d-block">
										<div data-value="@parcaSayisi">
											@if (parcaSayisi > 0)
											{
												<div class="d-flex align-items-center">
													<small class="text-muted text-truncate" style="max-width: 200px;">
														@malzemeOzet
													</small>
												</div>
											}
											else
											{
												<span class="text-muted small">-</span>
											}
										</div>
									</a>
								</td>
							</tr>
						}
					</tbody>
				</table>
				@if (Model.Count == 0)
				{
					<div class="text-center py-5">
						<p class="text-muted">Listelenecek üye yok.</p>
					</div>
				}
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		// --- ANLIK ARAMA ---
		$(document).ready(function () {
			$("#searchInput").on("keyup", function () {
				var value = $(this).val().toLowerCase();
				$("#kullaniciTable tbody tr").filter(function () {
					// İsim (0) ve Okul No (1) sütunlarında ara
					var nameText = $(this).find("td:eq(0)").text().toLowerCase();
					var noText = $(this).find("td:eq(1)").text().toLowerCase();
					$(this).toggle(nameText.indexOf(value) > -1 || noText.indexOf(value) > -1)
				});
			});
		});

		// --- SIRALAMA FONKSİYONU ---
		function sortTable(n, isNumber = false) {
			var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
			table = document.getElementById("kullaniciTable");
			switching = true;
			dir = "asc";

			while (switching) {
				switching = false;
				rows = table.rows;
				for (i = 1; i < (rows.length - 1); i++) {
					shouldSwitch = false;
					x = rows[i].getElementsByTagName("TD")[n];
					y = rows[i + 1].getElementsByTagName("TD")[n];

					// data-value varsa onu kullan (Sayısal sıralama için)
					var xVal = x.querySelector('[data-value]') ? x.querySelector('[data-value]').getAttribute('data-value') : x.innerText.trim().toLowerCase();
					var yVal = y.querySelector('[data-value]') ? y.querySelector('[data-value]').getAttribute('data-value') : y.innerText.trim().toLowerCase();

					if (isNumber) {
						var xNum = parseFloat(xVal) || 0;
						var yNum = parseFloat(yVal) || 0;

						if (dir == "asc") { if (xNum > yNum) { shouldSwitch = true; break; } }
						else { if (xNum < yNum) { shouldSwitch = true; break; } }
					} else {
						if (dir == "asc") { if (xVal > yVal) { shouldSwitch = true; break; } }
						else { if (xVal < yVal) { shouldSwitch = true; break; } }
					}
				}
				if (shouldSwitch) {
					rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
					switching = true;
					switchcount++;
				} else {
					if (switchcount == 0 && dir == "asc") {
						dir = "desc";
						switching = true;
					}
				}
			}
		}
	</script>
}